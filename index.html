<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DBP Auth</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        line-height: 1.6;
        margin: 0;
        padding: 20px;
        max-width: 800px;
        margin: 0 auto;
      }
      header {
        background-color: #f4f4f4;
        padding: 1rem;
        margin-bottom: 1rem;
      }
    </style>

    <script>
      // Add this function to get cookies
      // function getCookie(name) {
      //   const value = `; ${document.cookie}`;
      //   const parts = value.split(`; ${name}=`);
      //   if (parts.length === 2) return parts.pop().split(';').shift();
      //   return null;
      // }

      window.onload = async function () {
        const urlParams = new URLSearchParams(window.location.search);

        try {
          // Check if the 'code' parameter exists
          if (urlParams.has('code')) {
            console.log('Code parameter found:', urlParams.get('code'));

            // Get code verifier from cookie if it exists
            // const codeVerifier = getCookie('verifier');
            const requestBody = {
              code: urlParams.get('code'),
            };

            // Add code_verifier to request if it exists
            // if (codeVerifier) {
            //   requestBody.code_verifier = codeVerifier;
            // }

            const response = await fetch('https://api.cryptofi-dev.com/v2/dbp/auth', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify(requestBody),
            });

            if (!response.ok) {
              const errorText = await response.text();
              throw new Error(`Network response error: ${response.status}, ${errorText}`);
            }

            const data = await response.json();
            console.log('Auth successful:', data);

            // Store the token for future use
            if (data.id_token) {
              localStorage.setItem('investifi:idToken', data.id_token);
              // You could redirect to your app here if needed
            }
          } else {
            console.log('No code parameter found in URL, initiating auth flow');

            const response = await fetch('https://api.cryptofi-dev.com/v2/dbp/auth', {
              method: 'GET',
              headers: {
                'Fi-Id': '00000',
                'User-Account-Id': '106189141462849936086',
              },
            });

            if (!response.ok) {
              const errorText = await response.text();
              throw new Error(`Network response error: ${response.status}, ${errorText}`);
            }

            const data = await response.json();
            console.log('Redirect URL received:', data);

            // Check if PKCE is required
            const redirectUrl = new URL(data.redirect_url);

            // if (redirectUrl.searchParams.get('pkce_required') === 'True') {
            //   // If PKCE is required, we need to generate a challenge
            //   // Since we can't use pkce-challenge directly in vanilla JS,
            //   // we'll need to implement a simplified version or use a CDN

            //   // This is a placeholder - in production you'd need a proper PKCE implementation
            //   const codeVerifier = generateRandomString(50);
            //   const codeChallenge = base64URLEncode(codeVerifier); // This is simplified

            //   // Store code verifier in cookie
            //   document.cookie = `verifier=${codeVerifier}; path=/; max-age=3600`;

            //   // Add code challenge to redirect URL
            //   redirectUrl.searchParams.set('code_challenge', codeChallenge);

            //   console.log('PKCE enabled, added code challenge');
            // }

            // Redirect to the authorization URL
            window.location.replace(redirectUrl.toString());
          }
        } catch (error) {
          console.error('Auth error:', error);
        }
      };

      // // Simple random string generator for code verifier
      // function generateRandomString(length) {
      //   const charset = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~';
      //   let result = '';
      //   for (let i = 0; i < length; i++) {
      //     result += charset.charAt(Math.floor(Math.random() * charset.length));
      //   }
      //   return result;
      // }

      // // Simplified base64 URL encoding (not suitable for production)
      // function base64URLEncode(str) {
      //   // In a real implementation, you'd use a proper base64 encoding and URL-safe transformation
      //   // This is just a placeholder to show the concept
      //   return btoa(str).replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
      // }
    </script>
  </head>

  <body>
    <header>
      <h1>Auth test</h1>
    </header>
  </body>
</html>
